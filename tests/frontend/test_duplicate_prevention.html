<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Duplicate Prevention</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .test-section {
      border: 1px solid #ccc;
      padding: 15px;
      margin: 10px 0;
    }

    button {
      margin: 5px;
      padding: 8px 15px;
    }

    .create {
      background: #4CAF50;
      color: white;
    }

    .test {
      background: #2196F3;
      color: white;
    }

    #log {
      background: #f0f0f0;
      padding: 10px;
      margin: 10px 0;
      height: 300px;
      overflow-y: scroll;
      font-family: monospace;
    }

    .goal-count {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>

<body>
  <h1>üîç Duplicate Goal Prevention Test</h1>

  <div class="test-section">
    <h2>Goal Creation Test</h2>
    <p>This test creates goals and monitors for duplicates.</p>

    <div>
      <button class="create" onclick="createSingleGoal()">Create Single Goal</button>
      <button class="create" onclick="createMultipleGoals()">Create 3 Goals Rapidly</button>
      <button class="test" onclick="testDuplicateSubmission()">Test Duplicate Submission</button>
      <button onclick="refreshGoals()">Refresh Goals</button>
      <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="goal-count" id="goalCount">Goals: Loading...</div>
  </div>

  <div class="test-section">
    <h3>Goals List</h3>
    <div id="goalsList">Loading...</div>
  </div>

  <div class="test-section">
    <h3>Test Log</h3>
    <div id="log"></div>
  </div>

  <script>
    const API_URL = 'http://localhost:8000';
    let goalCreationCount = 0;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
      logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    async function createSingleGoal() {
      goalCreationCount++;
      const goalData = {
        title: `Test Goal ${goalCreationCount}`,
        description: `Single goal creation test #${goalCreationCount}`,
        category: 'Test'
      };

      log(`Creating single goal: "${goalData.title}"`);

      try {
        const response = await fetch(`${API_URL}/goals`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(goalData)
        });

        if (response.ok) {
          const goal = await response.json();
          log(`‚úÖ Goal created successfully: ID ${goal.id}`, 'success');
          setTimeout(refreshGoals, 500); // Wait for WebSocket updates
        } else {
          const error = await response.text();
          log(`‚ùå Failed to create goal: ${response.status} - ${error}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Error creating goal: ${error}`, 'error');
      }
    }

    async function createMultipleGoals() {
      log('Creating 3 goals rapidly...');

      const promises = [];
      for (let i = 1; i <= 3; i++) {
        goalCreationCount++;
        const goalData = {
          title: `Rapid Goal ${goalCreationCount}`,
          description: `Rapid creation test #${i}`,
          category: 'Test'
        };

        promises.push(
          fetch(`${API_URL}/goals`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(goalData)
          })
        );
      }

      try {
        const responses = await Promise.all(promises);
        let successCount = 0;

        for (let i = 0; i < responses.length; i++) {
          if (responses[i].ok) {
            const goal = await responses[i].json();
            log(`‚úÖ Rapid goal ${i + 1} created: ID ${goal.id}`, 'success');
            successCount++;
          } else {
            log(`‚ùå Rapid goal ${i + 1} failed: ${responses[i].status}`, 'error');
          }
        }

        log(`üìä Created ${successCount}/3 goals successfully`);
        setTimeout(refreshGoals, 1000); // Wait for WebSocket updates

      } catch (error) {
        log(`‚ùå Error in rapid creation: ${error}`, 'error');
      }
    }

    async function testDuplicateSubmission() {
      goalCreationCount++;
      const goalData = {
        title: `Duplicate Test ${goalCreationCount}`,
        description: 'Testing duplicate submission prevention',
        category: 'Test'
      };

      log('Testing duplicate submission (sending same request 3 times)...');

      // Send the same request multiple times rapidly
      const promises = [];
      for (let i = 0; i < 3; i++) {
        promises.push(
          fetch(`${API_URL}/goals`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(goalData)
          })
        );
      }

      try {
        const responses = await Promise.all(promises);
        const goals = [];

        for (let i = 0; i < responses.length; i++) {
          if (responses[i].ok) {
            const goal = await responses[i].json();
            goals.push(goal);
            log(`üìù Duplicate request ${i + 1} response: ID ${goal.id}`);
          } else {
            log(`‚ùå Duplicate request ${i + 1} failed: ${responses[i].status}`, 'error');
          }
        }

        // Check for duplicate IDs
        const uniqueIds = new Set(goals.map(g => g.id));
        if (uniqueIds.size === goals.length) {
          log(`‚úÖ All ${goals.length} goals have unique IDs`, 'success');
        } else {
          log(`‚ùå Found duplicate IDs! ${goals.length} goals, ${uniqueIds.size} unique IDs`, 'error');
        }

        setTimeout(refreshGoals, 1000);

      } catch (error) {
        log(`‚ùå Error in duplicate test: ${error}`, 'error');
      }
    }

    async function refreshGoals() {
      try {
        log('Refreshing goals list...');
        const response = await fetch(`${API_URL}/goals`);

        if (response.ok) {
          const goals = await response.json();
          displayGoals(goals);
          log(`üìä Loaded ${goals.length} goals`);
        } else {
          log(`‚ùå Failed to load goals: ${response.status}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Error loading goals: ${error}`, 'error');
      }
    }

    function displayGoals(goals) {
      const countDiv = document.getElementById('goalCount');
      const listDiv = document.getElementById('goalsList');

      countDiv.textContent = `Goals: ${goals.length}`;

      if (goals.length === 0) {
        listDiv.innerHTML = '<p>No goals found.</p>';
        return;
      }

      // Check for duplicates by title
      const titleCounts = {};
      goals.forEach(goal => {
        titleCounts[goal.title] = (titleCounts[goal.title] || 0) + 1;
      });

      const duplicates = Object.entries(titleCounts).filter(([title, count]) => count > 1);

      let html = '';

      if (duplicates.length > 0) {
        html += '<div style="background: #ffebee; padding: 10px; border: 1px solid #f44336; margin-bottom: 10px;">';
        html += '<strong>‚ö†Ô∏è Duplicate Titles Found:</strong><br>';
        duplicates.forEach(([title, count]) => {
          html += `‚Ä¢ "${title}" appears ${count} times<br>`;
        });
        html += '</div>';
      }

      html += '<table border="1" style="width: 100%; border-collapse: collapse;">';
      html += '<tr><th>ID</th><th>Title</th><th>Category</th><th>Progress</th><th>Created</th></tr>';

      goals.forEach(goal => {
        const isDuplicate = titleCounts[goal.title] > 1;
        const rowStyle = isDuplicate ? 'background-color: #ffebee;' : '';

        html += `<tr style="${rowStyle}">`;
        html += `<td>${goal.id}</td>`;
        html += `<td>${goal.title}</td>`;
        html += `<td>${goal.category || 'None'}</td>`;
        html += `<td>${Math.round(goal.progress_percentage)}%</td>`;
        html += `<td>${new Date(goal.created_at).toLocaleString()}</td>`;
        html += '</tr>';
      });

      html += '</table>';
      listDiv.innerHTML = html;
    }

    // Load goals on page load
    window.onload = () => {
      log('üîç Duplicate Prevention Test Started');
      log('This test helps identify if goal creation causes duplicates');
      refreshGoals();
    };
  </script>
</body>

</html>